// ALIVE Advertising Platform Database Schema
// Complete schema with all business models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model KiranaStore {
  id              String   @id @default(cuid())
  name            String
  ownerName       String
  ownerPhone      String   @unique
  email           String?  @unique

  // Location details
  address         String
  city            String
  state           String
  pincode         String
  latitude        Float
  longitude       Float

  // Store details
  storeType       String   @default("general")
  gstin           String?

  // Status
  isActive        Boolean  @default(true)
  isVerified      Boolean  @default(false)

  // Relations
  products        AdvertisedProduct[]
  orders          Order[]
  earnings        StoreEarning[]
  screenSlots     ScreenSlot[]
  rebates         Rebate[]
  electricityBills ElectricityBill[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([ownerPhone])
  @@index([latitude, longitude])
  @@index([city])
}

model Customer {
  id              String   @id @default(cuid())
  name            String
  phone           String   @unique
  email           String?  @unique

  // Wallet for cashback/credits
  walletBalance   Float    @default(0)

  // Status
  isActive        Boolean  @default(true)

  // Relations
  addresses       Address[]
  orders          Order[]
  cart            CartItem[]
  shoppingLists   ShoppingList[]
  electricityBills ElectricityBill[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([phone])
}

model Address {
  id              String   @id @default(cuid())

  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Address details
  label           String   @default("Home") // Home, Work, Other
  addressLine1    String
  addressLine2    String?
  city            String
  state           String
  pincode         String

  // Location
  latitude        Float?
  longitude       Float?

  // Default address flag
  isDefault       Boolean  @default(false)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  orders          Order[]

  @@index([customerId])
  @@index([latitude, longitude])
}

// ============================================
// PRODUCT & INVENTORY
// ============================================

model AdvertisedProduct {
  id              String   @id @default(cuid())

  // Product details
  name            String
  brand           String
  category        String
  description     String?
  imageUrl        String

  // Pricing
  mrp             Float
  discountedPrice Float
  discountPercent Float

  // Inventory
  stockQuantity   Int      @default(0)
  minOrderQty     Int      @default(1)
  maxOrderQty     Int      @default(10)

  // Commission structure
  commissionType  String   @default("percentage") // percentage or fixed
  commissionValue Float

  // Store relation
  kiranaStoreId   String
  kiranaStore     KiranaStore @relation(fields: [kiranaStoreId], references: [id], onDelete: Cascade)

  // Status
  isActive        Boolean  @default(true)
  isAvailable     Boolean  @default(true)

  // Relations
  orderItems      OrderItem[]
  cartItems       CartItem[]
  shoppingListItems ShoppingListItem[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([kiranaStoreId])
  @@index([category])
  @@index([brand])
}

model CartItem {
  id              String   @id @default(cuid())

  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  productId       String
  product         AdvertisedProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity        Int      @default(1)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([customerId, productId])
  @@index([customerId])
}

// ============================================
// SHOPPING LISTS
// ============================================

model ShoppingList {
  id              String   @id @default(cuid())

  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  name            String   @default("My Shopping List")
  isActive        Boolean  @default(true)

  // Relations
  items           ShoppingListItem[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([customerId])
}

model ShoppingListItem {
  id              String   @id @default(cuid())

  shoppingListId  String
  shoppingList    ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)

  // Product reference (optional - can be custom item)
  productId       String?
  product         AdvertisedProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Custom item name (if not linked to product)
  customItemName  String?

  quantity        Int      @default(1)
  isChecked       Boolean  @default(false)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([shoppingListId])
}

// ============================================
// ORDERS & FULFILLMENT
// ============================================

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model Order {
  id              String   @id @default(cuid())
  orderNumber     String   @unique

  // Customer relation
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])

  // Store relation
  kiranaStoreId   String
  kiranaStore     KiranaStore @relation(fields: [kiranaStoreId], references: [id])

  // Delivery address
  addressId       String?
  address         Address? @relation(fields: [addressId], references: [id], onDelete: SetNull)

  // Manual delivery details (if address is deleted)
  deliveryAddress String
  deliveryLat     Float?
  deliveryLng     Float?
  deliveryPhone   String

  // Order details
  items           OrderItem[]
  totalAmount     Float
  discountAmount  Float    @default(0)
  finalAmount     Float

  // Commission for store
  commissionAmount Float

  // Status
  status          OrderStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)

  // Payment details
  paymentMethod   String   @default("online") // online, cod, wallet
  razorpayOrderId String?
  razorpayPaymentId String?

  // Timestamps
  confirmedAt     DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([customerId])
  @@index([kiranaStoreId])
  @@index([addressId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id              String   @id @default(cuid())

  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId       String
  product         AdvertisedProduct @relation(fields: [productId], references: [id])

  // Snapshot of product at order time
  productName     String
  productImage    String
  mrp             Float
  discountedPrice Float

  quantity        Int
  totalPrice      Float

  // Commission for this item
  commissionAmount Float

  createdAt       DateTime @default(now())

  @@index([orderId])
}

// ============================================
// ELECTRICITY BILL MANAGEMENT
// ============================================

enum BillStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
}

model ElectricityBill {
  id              String   @id @default(cuid())
  billNumber      String   @unique

  // Customer who uploaded the bill
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])

  // Kirana store processing the payment
  kiranaStoreId   String
  kiranaStore     KiranaStore @relation(fields: [kiranaStoreId], references: [id])

  // Bill details
  billImageUrl    String
  amount          Float
  dueDate         DateTime?

  // Status
  status          BillStatus @default(PENDING)

  // Payment details
  paymentMethod   String?  @default("cash") // cash, online, wallet
  transactionId   String?
  paidAt          DateTime?

  // Commission/charges
  serviceCharge   Float    @default(0)
  kiranaCommission Float   @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([customerId])
  @@index([kiranaStoreId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// EARNINGS & PAYOUTS
// ============================================

enum EarningType {
  ORDER_COMMISSION
  SCREEN_AD
  BILL_COMMISSION
  REFERRAL
  BONUS
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

model StoreEarning {
  id              String   @id @default(cuid())

  kiranaStoreId   String
  kiranaStore     KiranaStore @relation(fields: [kiranaStoreId], references: [id], onDelete: Cascade)

  type            EarningType
  amount          Float
  description     String

  // Deductions (platform fee, tax, etc.)
  deduction       Float    @default(0)
  netAmount       Float    // amount - deduction

  // Payout tracking
  payoutStatus    PayoutStatus @default(PENDING)
  payoutDate      DateTime?
  payoutMethod    String?  // bank_transfer, upi, etc.
  payoutReference String?

  // References
  orderId         String?
  screenSlotId    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([kiranaStoreId])
  @@index([payoutStatus])
  @@index([createdAt])
}

model Rebate {
  id              String   @id @default(cuid())

  kiranaStoreId   String
  kiranaStore     KiranaStore @relation(fields: [kiranaStoreId], references: [id], onDelete: Cascade)

  // Rebate details
  brandName       String
  productCategory String
  rebateAmount    Float
  rebatePercent   Float?

  // Conditions
  minOrderValue   Float    @default(0)
  validFrom       DateTime
  validTill       DateTime

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([kiranaStoreId])
  @@index([isActive])
}

// ============================================
// SCREEN AD MANAGEMENT
// ============================================

model ScreenSlot {
  id              String   @id @default(cuid())

  kiranaStoreId   String
  kiranaStore     KiranaStore @relation(fields: [kiranaStoreId], references: [id], onDelete: Cascade)

  // Ad details
  brandName       String
  adImageUrl      String
  adVideoUrl      String?

  // Duration & pricing
  startDate       DateTime
  endDate         DateTime
  pricePerDay     Float
  totalAmount     Float

  // Metrics
  impressions     Int      @default(0)
  clicks          Int      @default(0)

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([kiranaStoreId])
  @@index([isActive])
  @@index([startDate, endDate])
}
